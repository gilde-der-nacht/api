<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
body {
    width: 40em;
    margin: 1em auto;
}

input[type=text] {
    width: 30em;
}
</style>
<script src="olymp.js"></script>
<script>
'use strict';

async function status() {
    const olymp = new Olymp({});
    const status = await olymp.status();
    document.getElementById('status-output').innerText = JSON.stringify(status);
}

async function add() {
    const olymp = new Olymp({});
    const resourceUid = document.getElementById('add-resource-uid').value;
    const identification = document.getElementById('add-identification').value;
    const publicBody = JSON.parse(document.getElementById('add-public').value);
    const privateBody = JSON.parse(document.getElementById('add-private').value);
    await olymp.entriesAdd(resourceUid, identification, publicBody, privateBody);
}

async function list() {
    const olymp = new Olymp({});
    const resourceUid = document.getElementById('list-resource-uid').value;
    const list = await olymp.entriesList(resourceUid);
    document.getElementById('list-output').innerText = list.map(entry => entry.timestamp + ' - ' + entry.userAgent + ' - ' + entry.publicBody + ' - ' + entry.privateBody).join('\n');
}

async function test() {
    function expect(condition) {
        if(!condition) {
            // as "new {}" produces an exception, the following lines are just an ugly hack to always get a stack trace
            let stack = '';
            try { new {}; } catch(exception) { stack = exception.stack; }
            testLog(stack);
        }
    }

    function testLog() {
        const message = [...arguments].join(' ') + '\n';
        document.getElementById('test-log').innerText += message;
    }

    testLog('tests started');

    const JSON_EMPTY = {identification: '', publicBody: {}, privateBody: {}};

    {
        expect(!Olymp._verifyBody('{}'));
        expect(Olymp._verifyBody({}));
        expect(Olymp._verifyIdentification(''));
        expect(Olymp._verifyIdentification('1234'));
        expect(!Olymp._verifyIdentification(0));
        expect(!Olymp._verifyUid(''));
        expect(!Olymp._verifyUid('0'));
        expect(Olymp._verifyUid(RESOURCE_UID_EMPTY));
        expect(Olymp._verifyUid(RESOURCE_UID_TEST));
        expect(!Olymp._verifyUid(RESOURCE_UID_TEST + '0'));
    }

    // test the service with raw get/post/put/delete methods

    {
        const PATH_EMPTY = '/resources/' + RESOURCE_UID_EMPTY + '/entries';
        const PATH_TEST = '/resources/' + RESOURCE_UID_TEST + '/entries';
        const JSON_EMPTY_STRING = JSON.stringify(JSON_EMPTY);

        const [_, status] = await HTTP.get('/invalid-url');
        expect(status === HTTP.CODES.NOT_FOUND_404);

        expect((await HTTP.put(PATH_EMPTY, JSON_EMPTY_STRING))[1] === HTTP.CODES.METHOD_NOT_ALLOWED_405);

        expect((await HTTP.delete(PATH_EMPTY))[1] === HTTP.CODES.METHOD_NOT_ALLOWED_405);

        expect((await HTTP.post(PATH_TEST, JSON_EMPTY_STRING))[1] === HTTP.CODES.CREATED_201);

        expect((await HTTP.post(PATH_TEST, 'X'.repeat(1000000)))[1] === HTTP.CODES.REQUEST_ENTITY_TOO_LARGE_413);

        expect((await HTTP.get(PATH_TEST))[1] === HTTP.CODES.OK_200);

        expect((await HTTP.post(PATH_EMPTY, JSON_EMPTY_STRING))[1] === HTTP.CODES.INTERNAL_SERVER_ERROR_500); // TODO return another error code
    }

    // test the service with the library the client uses

    {
        async function run(olymp) {
            const status = await olymp.status();
            expect('version' in status);
            expect('time' in status);
            expect(status.version === '0.0.0');

            const length1 = (await olymp.entriesList(RESOURCE_UID_TEST)).length;
            await olymp.entriesAdd(RESOURCE_UID_TEST, '', {data: 'public'}, {data: 'private'});
            const length2 = (await olymp.entriesList(RESOURCE_UID_TEST)).length;
            expect((length1 + 1) == length2);

            const entries = await olymp.entriesList(RESOURCE_UID_TEST);
            entries.forEach(entry => {
                expect('resourceUid' in entry);
                expect('entryUid' in entry);
                expect('timestamp' in entry);
                expect('publicBody' in entry);
                expect('privateBody' in entry);
                expect('url' in entry);
                expect('userAgent' in entry);
            });
        }

        await run(new Olymp({}));
        await run(new OlympMock({}));
    }

    // example registration

    {
        const olymp = new OlympMock({});

        const RESOURCE_UID = '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef';

        await olymp.resourceAdd(RESOURCE_UID);

        // user updates the information 3 times
        await olymp.entriesAdd(RESOURCE_UID, 'a@unknown.tld', {rounds: ['GM-0']}, {name: 'a', email: 'a@unknown.tld'});
        await olymp.entriesAdd(RESOURCE_UID, 'a@unknown.tld', {rounds: ['GM-0', 'GM-1']}, {name: 'a', email: 'a@unknown.tld'});
        await olymp.entriesAdd(RESOURCE_UID, 'a@unknown.tld', {rounds: ['GM-0', 'GM-1', 'GM-2']}, {name: 'a', email: 'a@unknown.tld'});

        await olymp.entriesAdd(RESOURCE_UID, 'b@unknown.tld', {rounds: ['GM-0']}, {name: 'b', email: 'b@unknown.tld'});
        await olymp.entriesAdd(RESOURCE_UID, 'c@unknown.tld', {rounds: ['GM-0']}, {name: 'c', email: 'c@unknown.tld'});
        await olymp.entriesAdd(RESOURCE_UID, 'd@unknown.tld', {rounds: ['GM-0']}, {name: 'd', email: 'd@unknown.tld'});
        await olymp.entriesAdd(RESOURCE_UID, 'e@unknown.tld', {rounds: ['GM-0']}, {name: 'e', email: 'e@unknown.tld'});

        const status = await olymp.status();
        expect(status.version === '0.0.0');

        const registrations = await olymp.entriesList(RESOURCE_UID);

        expect(registrations.length == 5); // double registrations are removed

        registrations.forEach(registration => {
            testLog(registration.timestamp, registration.publicBody.userId, registration.publicBody.rounds);
        });
    }

    testLog('tests finished');
}


async function main() {
    document.getElementById('status').addEventListener('click', status);
    document.getElementById('add').addEventListener('click', add);
    document.getElementById('list').addEventListener('click', list);
    document.getElementById('test').addEventListener('click', test);
    if(false) {
        await status();
        await test();
        await list();
    }
}

window.addEventListener('load', main);
</script>
</head>
<body>

<h1>Olymp Admin</h1>

<h2>status</h2>

<input id="status" type="button" value="status">

<pre id="status-output"></pre>

<h2>test</h2>

<input id="test" type="button" value="test">

<pre id="test-log"></pre>

<h2>add entry</h2>

<p>Resource UID <input id="add-resource-uid" type="text" value="0000000000000000000000000000000000000000000000000000000000000000"></p>
<p>Identification UID <input id="add-identification" type="text" value=""></p>
<p>Public <input id="add-public" type="text" value="{&quot;data&quot;: &quot;Hello&quot;}"></p>
<p>Private <input id="add-private" type="text" value="{&quot;data&quot;: &quot;x@y.z&quot;}"></p>

<input id="add" type="button" value="add">

<pre id="add-output"></pre>

<h2>list all entries</h2>

<p>Resource UID <input id="list-resource-uid" type="text" value="0000000000000000000000000000000000000000000000000000000000000000"></p>

<input id="list" type="button" value="list">

<pre id="list-output"></pre>

<h2>form</h2>

<form action="/form/0000000000000000000000000000000000000000000000000000000000000000" method="POST">
    <p>a-public <input name="public-a-name" type="text" value="public-a-value"></p>
    <p>b-public <input name="public-b-name" type="text" value="public-b-value"></p>
    <p>c-public <input name="public-c-name" type="text" value="public-c-value"></p>
    <p>c-private <input name="private-d-name" type="text" value="private-d-value"></p>
    <input name="public-d-name" type="hidden" value="public-d-value ö">
    <input name="public-e-name" type="hidden" value="public-e-value ä">
    <input name="public-f-name" type="hidden" value="public-f-value ü">
    <input name="_redirect" type="hidden" value="/admin">
    <input type="submit">
</form>

<pre id="form-output"></pre>

</body>
</html>
