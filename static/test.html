<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
body {
    width: 40em;
    margin: 1em auto;
}
</style>
<script src="app.js"></script>
<script>
'use strict';

function logAdd(message) {
    document.getElementById('log').innerText += message;
}

function expect(condition) {
    if(!condition) {
        let stack = '';
        try { new {}; } catch(exception) { stack = exception.stack; }
        logAdd(stack);
    }
}

async function main() {
    logAdd('tests started\n');

    // test the service with raw get/post/put/delete methods

    // this resource is empty forever
    const UID_EMPTY = 'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

    // this resource is just to add anything you like, entries may be deleted occasionally by an administrator
    const UID_TEST = '0000000000000000000000000000000000000000000000000000000000000000';

    const JSON_EMPTY = {'publicBody': {}, 'privateBody': {}};

    {
        const [_, status] = await HTTP.get('/invalid-url');
        expect(status === HTTP.CODES().CODE_404_NOT_FOUND);

        expect((await HTTP.get('/invalid-url'))[1] === HTTP.CODES().CODE_404_NOT_FOUND);
    }

    {
        const PATH_EMPTY = '/resources/' + UID_EMPTY + '/entries';
        const PATH_TEST = '/resources/' + UID_TEST + '/entries';
        const JSON_EMPTY_STRING = JSON.stringify(JSON_EMPTY);

        expect((await HTTP.put(PATH_EMPTY, JSON_EMPTY_STRING))[1] === HTTP.CODES().CODE_405_METHOD_NOT_ALLOWED);

        expect((await HTTP.delete(PATH_EMPTY))[1] === HTTP.CODES().CODE_405_METHOD_NOT_ALLOWED);

        expect((await HTTP.post(PATH_TEST, JSON_EMPTY_STRING))[1] === HTTP.CODES().CODE_201_CREATED);

        expect((await HTTP.get(PATH_TEST))[1] === HTTP.CODES().CODE_200_OK);
    }

    // test the service with the library the client uses

    {
        const status = await App.status();
        expect('version' in status);
        expect('time' in status);
        expect(status.version === '0.0.0');
    }

    {
        expect(!App._verifyBody('{}'));
        expect(App._verifyBody({}));

        expect(!App._verifyUid(''));
        expect(!App._verifyUid('0'));
        expect(App._verifyUid(UID_EMPTY));
        expect(App._verifyUid(UID_TEST));
        expect(!App._verifyUid(UID_TEST + '0'));
    }

    {
        // add one element
        const length1 = (await App.entriesList(UID_TEST)).length;
        await App.entriesAdd(UID_TEST, {'data': 'public'}, {'data': 'private'});
        const length2 = (await App.entriesList(UID_TEST)).length;
        expect((length1 + 1) == length2);
    }

    logAdd('tests finished\n');
}

window.addEventListener('load', main);
</script>
</head>
<body>

<h1>Test</h1>

<pre id="log"></pre>

</body>
</html>
