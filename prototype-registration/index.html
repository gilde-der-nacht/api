<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

* {
    box-sizing: border-box;
}

body {
    width: 40em;
    margin: 1em auto;
}

.full {
    opacity: 0.2;
    pointer-events: none;
}

input[type=text], textarea {
    width: 100% ;
}

.round {
    border: 1px solid #f0f;
}

.hint {
    background-color: #fcc;
}

#rounds, #summaries {
    font-size: 0.8em;
}

#rounds {
    display: flex;
    flex-wrap: wrap;
}

.player {
    width: 100%;
    border: 1px solid #ccc;
    background-color: #eee;
}

</style>
<!--
<script src="http://127.0.0.1:5000/app.js"></script>
-->
<script>
'use strict';

async function digest(message) {
    // TODO
    // how portable is this? better use a library?
    // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest
    // https://www.npmjs.com/package/js-sha256
    // add this to the library
    // await is somehow not expected here IMHO as it is just a calculation
    // some kind of hmac would be better? or else an attacker can try out email addresses
    // ask the server to apply some kind of encrpytion on specific fields?
    // maybe there is no public/private generated by the client, but by the server and the client requests to 'hide/encrypt' elements

    async function digestMessage(message) {
        const encoder = new TextEncoder();
        const data = encoder.encode(message);
        const result = await window.crypto.subtle.digest('SHA-256', data);
        return result;
    }

    function hexString(buffer) {
        const byteArray = new Uint8Array(buffer);
        const hexCodes = [...byteArray].map(value => {
            const hexCode = value.toString(16);
            const paddedHexCode = hexCode.padStart(2, '0');
            return paddedHexCode;
        });
        return hexCodes.join('');
    }

    return hexString(await digestMessage(message));
}

async function main() {
    const GAMES = {
        'Adrian-0': {
            name: 'Shadowrun',
            gm: 'Adrian',
            gameDescription: 'Dystopisch BlaBla ...',
            campaignDescription: 'BlaBla ...',
            lang: 'DE',
            playersMax: 5,
        },
        'Manuela-0': {
            name: 'Finsterwald',
            gm: 'Manuela',
            gameDescription: 'Steampunk Blabla ...',
            campaignDescription: 'BlaBla ...',
            lang: 'DE',
            playersMax: 4,
        },
        'EnglishMan-0': {
            name: 'D&D',
            gm: 'EnglishMan',
            gameDescription: 'D & D Blabla ...',
            campaignDescription: 'Hack & Slash BlaBla ...',
            lang: 'EN',
            playersMax: 2,
        },
    };

    const ROUNDS = {
        'Adrian-0': { gameId: 'Adrian-0', day: 'friday', from: 13, to: 15 },
        'Adrian-1': { gameId: 'Adrian-0', day: 'friday', from: 15, to: 17 },
        'Adrian-2': { gameId: 'Adrian-0', day: 'saturday', from: 13, to: 15 },

        'Manuela-0': { gameId: 'Manuela-0', day: 'friday', from: 13, to: 15 },
        'Manuela-1': { gameId: 'Manuela-0', day: 'friday', from: 15, to: 17 },
        'Manuela-2': { gameId: 'Manuela-0', day: 'saturday', from: 13, to: 15 },

        'EnglishMan-0': { gameId: 'EnglishMan-0', day: 'friday', from: 13, to: 15 },
        'EnglishMan-1': { gameId: 'EnglishMan-0', day: 'friday', from: 15, to: 17 },
        'EnglishMan-2': { gameId: 'EnglishMan-0', day: 'saturday', from: 13, to: 15 },
    };

    /*
    TODO check api and log error if it doesn't match
    const status = await App.status();
    console.log(status);
    console.assert(status.version === '0.0.0');
    */

    const REGISTRATION_UID = '...';
    //const registrations = await App.getEntries(REGISTRATION_UID);
    const registrationsAll = [
        {publicBody: {roundId: 'Adrian-0', userId: '1'}, privateBody: {name: 'a', email: 'a@unknown.tld'}},
        {publicBody: {roundId: 'Adrian-0', userId: '2'}, privateBody: {name: 'b', email: 'b@unknown.tld'}},
        {publicBody: {roundId: 'Adrian-0', userId: '3'}, privateBody: {name: 'c', email: 'c@unknown.tld'}},
        {publicBody: {roundId: 'Adrian-0', userId: '4'}, privateBody: {name: 'd', email: 'd@unknown.tld'}},
        {publicBody: {roundId: 'Adrian-0', userId: '5'}, privateBody: {name: 'e', email: 'e@unknown.tld'}},

        {publicBody: {roundId: 'Adrian-1', userId: '1'}, privateBody: {name: 'a', email: 'a@unknown.tld'}},
    ];

    // TODO filter double/triple/... regstriations, only take the most recent one, add this function to the library as everyone using the API quite likely has the same requirement
    const registrations = registrationsAll;

    const submitNode = document.getElementById('submit');

    const i18nNode = document.getElementById('i18n');
    const i18nMap = {};
    i18nNode.content.querySelectorAll('*').forEach(child => {
        i18nMap[child.dataset.id] = child.dataset.text;
    });
    function tr(what) {
        return i18nMap[what];
    }

    async function submit() {
        const nameNode = document.getElementById('name');
        const emailNode = document.getElementById('email');
        const commentNode = document.getElementById('comment');

        const name = nameNode.value;
        const email = emailNode.value;
        const comment = commentNode.value;
        const userId = await digest(email);

        const publicBody = {
            roundId: '',
            userId: userId,
        };
        const privateBody = {
            name: name,
            email: email,
            comment: comment,
        };

        const debugNode = document.getElementById('debug');
        debugNode.innerText = JSON.stringify(publicBody) + '\n' + JSON.stringify(privateBody);

        // TODO verify selection, current > max (in case CSS does not work fully), overlapping games
        // TODO send
        // TODO refresh page after sending? or just remove selection add show comment?
    }

    // TODO there is too much global here

    function change() {
        showSummaries();
    }

    function replaceWithFragment(node, fragment) {
        node.innerHTML = ''; // ugly?
        node.appendChild(fragment);
    }

    function showRoundsOverview() {
        const roundsOverviewNode = document.getElementById('rounds-overview');
        const fragment = document.createDocumentFragment();

        // TODO use template? add div to allow page-break and other stuff
        let html = '';
        Object.keys(ROUNDS).forEach(roundId => {
            const round = ROUNDS[roundId];
            const game = GAMES[round.gameId];
            html += '<h2>' + game.name + ' - ' + game.gm + '</h2>';
            registrations.forEach(registration => {
                if(registration.publicBody.roundId === roundId) {
                    const name = registration.privateBody.name;
                    html += '<div class="player">' + name + '</div>';
                }
            });
        });

        roundsOverviewNode.innerHTML = html;
        //replaceWithFragment(roundsOverviewNode, fragment);
    }

    function showGmsOverview() {
        const gmsOverviewNode = document.getElementById('gms-overview');
        const fragment = document.createDocumentFragment();

        const gms = {};
        Object.keys(ROUNDS).forEach(roundId => {
            const round = ROUNDS[roundId];
            const game = GAMES[round.gameId];
            if(!(game.gm in gms)) {
                gms[game.gm] = [];
            }
            gms[game.gm].push(round);
        });

        let html = '';
        Object.keys(gms).forEach(gm => {
            html += '<h2>' + gm + '</h2>';
            gms[gm].forEach(round => {
                html += '<p>' + GAMES[round.gameId].name + ' ' + round.day + ' ' + round.from + '-' + round.to + '</p>';
            });
        });
        gmsOverviewNode.innerHTML = html;

        //replaceWithFragment(gmsOverviewNode, fragment);
    }

    function showSummaries(event) {
        const summaryTemplateNode = document.getElementById('summary-template');
        const summariesNode = document.getElementById('summaries');
        const roundsNode = document.getElementById('rounds');

        const fragment = document.createDocumentFragment();

        const roundNodes = roundsNode.querySelectorAll('[data-id=container]');
        roundNodes.forEach(roundNode => {
            const roundId = roundNode.dataset.roundId;

            const checkboxNode = roundNode.querySelector('[data-id=checkbox]');
            const hintNode = roundNode.querySelector('[data-id=hint]');

            hintNode.innerText = checkboxNode.checked ? 'SELECTED' : 'NOT SELECTED?'; // TODO do something useful here or remove it

            if(checkboxNode.checked === true) {
                const round = ROUNDS[roundId];
                const game = GAMES[round.gameId];

                const templateNode = summaryTemplateNode.content.cloneNode(true);
                templateNode.querySelector('[data-id=name]').innerText = game.name;
                templateNode.querySelector('[data-id=day]').innerText = tr(round.day);
                templateNode.querySelector('[data-id=from]').innerText = round.from;
                templateNode.querySelector('[data-id=to]').innerText = round.to;
                fragment.appendChild(templateNode);
            }
        });

        replaceWithFragment(summariesNode, fragment);
    }

    function showRounds() {
        const roundTemplateNode = document.getElementById('round-template');
        const roundsNode = document.getElementById('rounds');

        const fragment = document.createDocumentFragment();

        Object.keys(ROUNDS).forEach(roundId => {
            const round = ROUNDS[roundId];
            const game = GAMES[round.gameId];

            const playersMax = game.playersMax;
            const playersCurrent = registrations.filter(registration => {
                return registration.publicBody.roundId === roundId;
            }).length;

            const templateNode = roundTemplateNode.content.cloneNode(true);
            if(playersCurrent === playersMax) {
                templateNode.querySelector('[data-id=container]').classList.add('full');
            }
            templateNode.querySelector('[data-id=container]').dataset.roundId = roundId;
            templateNode.querySelector('[data-id=name]').innerText = game.name;
            templateNode.querySelector('[data-id=gm]').innerText = game.gm;
            templateNode.querySelector('[data-id=game-description]').innerText = game.gameDescription;
            templateNode.querySelector('[data-id=campaign-description]').innerText = game.campaignDescription;
            templateNode.querySelector('[data-id=lang]').innerText = game.lang;
            templateNode.querySelector('[data-id=lang-img]').src = tr('flag-url-' + game.lang);
            templateNode.querySelector('[data-id=day]').innerText = tr(round.day);
            templateNode.querySelector('[data-id=from]').innerText = round.from;
            templateNode.querySelector('[data-id=to]').innerText = round.to;
            templateNode.querySelector('[data-id=players-current]').innerText = playersCurrent;
            templateNode.querySelector('[data-id=players-max]').innerText = game.playersMax;
            const checkboxNode = templateNode.querySelector('[data-id=checkbox]');
            checkboxNode.addEventListener('change', change);
            fragment.appendChild(templateNode);
        });

        replaceWithFragment(roundsNode, fragment);
    }

    submitNode.addEventListener('click', submit);

    showRoundsOverview();
    showGmsOverview();
    showRounds();
    showSummaries();
    submit();
}

window.addEventListener('load', main);

</script>
</head>
<body>

<template id="i18n">
    <p data-id="friday" data-text="Freitag">-</p>
    <p data-id="saturday" data-text="Samstag">-</p>
    <!-- e.g. countryflags.com -->
    <p data-id="flag-url-DE" data-text="germany-flag-small.png">-</p>
    <p data-id="flag-url-EN" data-text="united-kingdom-flag-small.png">-</p>
</template>

<template id="round-template">
    <label data-id="container">
        <div class="round">
            <h1>Name: <span data-id="name"></span></h1>
            <p>Spielleiter: <span data-id="gm"></span></p>
            <p>Spielbeschreibung: <span data-id="game-description"></span></p>
            <p>Kampagnenbeschreibung: <span data-id="campaign-description"></span></p>
            <p>Sprache: <span data-id="lang"></span> <img height="10" data-id="lang-img"></p>
            <p>Tag/Zeit: <span data-id="day"></span> / <span data-id="from"></span> - <span data-id="to"></span></p>
            <p>Spieler Aktuell: <strong><span data-id="players-current"></span></strong> / Max: <span data-id="players-max"></span></p>
            <p class="hint">HINT/HERE <span data-id="hint"></span></p>
            <input data-id="checkbox" type="checkbox">
        </div>
    </label>
</template>

<template id="summary-template">
    <p data-id="container">Name: <span data-id="name"></span> / Tag <span data-id="day"></span> / Von <span data-id="from"></span> / Bis <span data-id="to"></span></p>
</template>

<h1>Rounds - Only Arganization - AUTH</h1>

<div id="rounds-overview"></div>

<h1>GMs - Only Organization - AUTH</h1>

<div id="gms-overview"></div>

<h1>Public</h1>

<!-- for everyone -->
<div id="rounds"></div>
<p><input type="text" id="name" value="Hans Muster"></p>
<p><input type="text" id="email" value="hans@muster.com"></p>
<p><textarea id="comment">bla blib blub</textarea></p>
<p><button id="submit">Submit</button></p>
<div id="summaries"></div>

<pre id="debug"></pre>

<p>Bats frighten me. It's time my enemies shared my dread.</p>
<p>Carbon fiber, .28 caliber, made in China. If you wanna kill a public servant, Mr Maroni... I recommend you buy American.</p>
<p>I just the took to calling it the Bat. And yes Mr. Wayne, it does come in black.</p>
<p>Death does not wait for you to be ready! Death is not considerate of fair! And make no mistake, here you face death. Tiger. Jujitsu. Panther. You're skilled. But this is not a dance. And you are afraid. But not of me. Tell us Mr. Wayne, what do you fear?</p>
<p>Dr. Crane isn't here right now. But if you'd like to make an appointment.</p>

</body>
</html>
